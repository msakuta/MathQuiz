<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MathQuiz</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<style>
			body {
				color: #000000;
				font-size:15px;
				text-align:center;

				background-color: #f0f0f0;
				margin: 0px;
			}

			#container{
				position: relative;
			}

			#points{
				font-size: 25px;
			}

			table{
				background-color: #f7c0a0;
				border: 3px solid #7f7f7f;
				border-collapse: collapse;
				/* Centering */
				margin-left: auto;
				margin-right: auto;
			}
			td{background-color: #ffe0d0}
			th{background-color: #e0c0a0}
			td, th{padding: 2px; border: 2px solid #7f7f7f}
		</style>
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
		  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
		  TeX: {
			TagSide: "left",
			Macros: {
			  T: '^{\\mathrm T}',
			  RR: '{\\bf R}',
			  bold: ['{\\bf #1}',1]
			}
		  }
		});
		</script>
		<script type="text/javascript"
		 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	</head>
	<body>
		<h1>MathQuiz</h1>
		Select classes of problems below and press "Start Over".
		<table style="text-align: left;  border: 2px solid #afafaf">
		<tr><td><input type="checkbox" id="dpoly" checked>Derivative of polynomials</td>
		<td><input type="checkbox" id="delem" checked>Derivative of elementary functions</td></tr>
		<tr><td><input type="checkbox" id="ipoly" checked>Integral of polynomials</td>
		<td><input type="checkbox" id="ielem" checked>Integral of elementary functions</td></tr>
		<tr><td><input type="checkbox" id="comp" checked>Complex numbers</td>
		<td><input type="checkbox" id="compdiv">Complex numbers division</td></tr>
		</table>
		<p><input type="button" onclick="start()" value="Start Over"></p>
		<table id="scoreboard">
		</table>
		<hr>
		<div id="container">

			<div id="problem">
			</div>

<input type="radio" name="answer" id="1"><span id="ans1"></span>
<input type="radio" name="answer" id="2"><span id="ans2"></span>
<input type="radio" name="answer" id="3"><span id="ans3"></span>
<input type="radio" name="answer" id="4"><span id="ans4"></span>
<p><input type="button" value="Answer" onclick="answer()"></p>
</div>
		<div id="message" style="font-size: 15pt; color: red; font-weight: bold"></div>
		<div><input type="button" id="next" onclick="next()" value="Next Problem" style="display: none"></div>
		<div id="points" style="font-size: 15pt; display:none; font-weight: bold"></div>
		<hr>
		<div id="highScores"></div>
		<hr>
		<div>Source on <a href="https://github.com/msakuta/MathQuiz">GitHub</a>.</div>
		<div>Powered by <a href="https://www.mathjax.org/">MathJax</a>.</div>

		<script>

// Constants
var optionCount = 4;
var probCount = 10;

var currentProblem = 0;
var results;
var correctAns;
var probClasses = [];

/// Mix fields of source into target.
/// This can be used like a dirty multiple inheritance.
function mixin(target, source){
	for(var k in source){
		target[k] = source[k];
	}
}

/// Custom inheritance function that prevents the super class's constructor
/// from being called on inehritance.
/// Also assigns constructor property of the subclass properly.
/// @param subclass The constructor of subclass that should be inherit base
/// @param base The constructor of the base class which subclass's prototype should point to.
/// @param methods Optional argument for a table containing methods to define for subclass.
///                The table is mixed-in to subclass, so it won't be a base class of subclass.
function inherit(subclass,base,methods){
	// If the browser or ECMAScript supports Object.create, use it
	// (but don't remember to redirect constructor pointer to subclass)
	if(Object.create){
		subclass.prototype = Object.create(base.prototype);
	}
	else{
		var sub = function(){};
		sub.prototype = base.prototype;
		subclass.prototype = new sub;
	}
	if(methods)
		mixin(subclass.prototype, methods);
	subclass.prototype.constructor = subclass;
}

/// ------------- Complex class --------------------------
function Complex(){
	this.a = [Math.floor(Math.random() * 10) - 5, Math.floor(Math.random() * 10) - 5];
	this.b = [Math.floor(Math.random() * 10) - 5, Math.floor(Math.random() * 10) - 5];
}

/// ------------- ComplexAdd class --------------------------
function ComplexAdd(){
	Complex.call(this);
}
inherit(ComplexAdd, Complex);

ComplexAdd.prototype.solution = function(){
	return formatComplex(complexAdd(this.a, this.b));
}

ComplexAdd.prototype.formatProblem = function(){
	return parenComplex(this.a) + "+" + parenComplex(this.b);
}

/// ------------- ComplexMultiply class --------------------------
function ComplexMultiply(){
	Complex.call(this);
}
inherit(ComplexMultiply, Complex);

ComplexMultiply.prototype.solution = function(){
	return formatComplex(complexMultiply(this.a, this.b));
}

ComplexMultiply.prototype.formatProblem = function(){
	return parenComplex(this.a) + parenComplex(this.b);
}

/// ------------- ComplexDivision class --------------------------
function ComplexDivision(){
	Complex.call(this);
	// Prevent zero division
	while(this.b[0] === 0 && this.b[1] === 0)
		this.b = [Math.floor(Math.random() * 10) - 5, Math.floor(Math.random() * 10) - 5];
}
inherit(ComplexDivision, Complex);

ComplexDivision.prototype.solution = function(){
	var div = complexDivision(this.a, this.b);
	if(div[0][0] === 0 && div[0][1] === 0)
		return "0";
	else if(div[1] === 1)
		return formatComplex(div[0]);
	else
		return "\\frac{" + formatComplex(div[0]) + "}{" + div[1] + "}";
}

ComplexDivision.prototype.formatProblem = function(){
	return "\\frac{" + formatComplex(this.a) + "}{" + formatComplex(this.b) + "}";
}


/// Enclose by parentheses if necessary
function parenComplex(a){
	if(a[0] !== 0 && a[1] !== 0 || a[0] < 0 || a[1] < 0)
		return "(" + formatComplex(a) + ")";
	else
		return formatComplex(a);
}

function formatComplex(a){
	if(a[0] === 0 && a[1] === 0)
		return "0";
	else if(a[0] !== 0 && a[1] === 0)
		return a[0];
	else if(a[0] === 0 && a[1] !== 0)
		return (a[1] === 1 ? "" : a[1] === -1 ? "-" : a[1]) + "i";
	else
		return a[0] + (a[1] < 0 ? "-" : "+") + (Math.abs(a[1]) === 1 ? "" : Math.abs(a[1])) + "i";
}

function complexAdd(a, b){
	return [a[0] + b[0], a[1] + b[1]];
}

function complexMultiply(a, b){
	return [a[0] * b[0] - a[1] * b[1], a[0] * b[1] + a[1] * b[0]];
}

function complexDivision(a, b){
	var divisor = b[0] * b[0] + b[1] * b[1];
	var r = b[0];
	var i = -b[1];
	var r1 = a[0] * r - a[1] * i;
	var i1 = a[0] * i + a[1] * r;
	var div = gcd3(r1, i1, divisor);
	return [[r1 / div, i1 / div], divisor / div];
}

/// Find the greatest common divisor of 3 values with brute force
function gcd3(a, b, c){
	var m = Math.max(a, Math.max(b, c));
	for(var i = m; 0 < i; i--){
		if((a === 0 || a % i === 0) && (b === 0 || b % i === 0) && c % i === 0)
			return i;
	}
	return 1;
}

/// ------------- Derivative class --------------------------
function Derivative(){

}

Derivative.prototype.solution = function(){
	return formatFormula(symbolicDerivative(this.vec));
}

Derivative.prototype.formatProblem = function(){
	return "\\frac{d}{dx} "
		+ "\\left\\{" + formatFormula(this.vec) + " \\right\\}";
}

/// ------------- Integral class --------------------------
function Integral(){

}

Integral.prototype.solution = function(){
	return formatFormula(symbolicIntegral(this.vec));
}

Integral.prototype.formatProblem = function(){
	return "\\int"
		+ "\\left\\{" + formatFormula(this.vec) + " \\right\\}"
		+ "dx";
}


function formatFormula(vec){
	var sign = vec[0], f = vec[1], pow = vec[2], fun = vec[3], f2 = vec[4], pow2 = vec[5], constant = vec[6];
	if(f === 0)
		return constant ? "C" : "0";
	// Normalize notation
	if(f < 0){
		sign *= -1;
		f *= -1;
	}

	var primary = pow === 0 ? "" : Math.abs(pow) === 1 ? "x" : "x^{" + Math.abs(pow) + "}";
	var factor = ((0 < pow || fun !== "") && f === 1 ? primary === "" && fun === "" ? "1" : "" : f);
	var factor2 = (0 < pow2 && f2 === 1 ? "" : f2);
	var signStr = sign < 0 ? "-" : "";
	var ret = f === 0 ? "0" : pow < 0 ? signStr + "\\frac{" + factor + "}{" + primary + "}" : signStr + factor + primary;
	if(fun !== ""){
		var primary2 = pow2 === 0 ? "" : Math.abs(pow2) === 1 ? "x" : "x^{" + Math.abs(pow2) + "}";
		ret += fun + "\\left(" + (pow2 < 0 ? "\\frac{" + factor2 + "}{" + primary2 + "}" : factor2 + primary2) + "\\right)";
	}
	if(constant)
		ret += "+C";
	return ret;
}

function generatePoly(integral){
	var sign = (Math.floor(Math.random() * 2)) * 2 - 1;
	var f = Math.floor(Math.random() * 10);
	var fun = "";
	var pow = Math.floor(Math.random() * 10) - 5;
	if(integral && pow !== 0)
		f *= pow+1;
	var f2 = 0;
	var pow2 = 0;
	return [sign, f, pow, fun, f2, pow2, false];
}

function DPoly(){
	Derivative.call(this);
	this.vec = generatePoly(false);
}
inherit(DPoly, Derivative);

function IPoly(){
	Integral.call(this);
	this.vec = generatePoly(true);
}
inherit(IPoly, Integral);

function generateDElem(funcList){
	var sign = (Math.floor(Math.random() * 2)) * 2 - 1;
	var f = Math.floor(Math.random() * 6) + 1;
	var fun = funcList[Math.floor(Math.random() * funcList.length)];
	var pow = 0;
	var f2 = fun === "\\log" ? 1 : Math.floor(Math.random() * 6) + 1;
	var pow2 = Math.floor(Math.random() * 6) - 3;
	if(0 <= pow2) // Prevent constant argument
		pow2++;
	return [sign, f, pow, fun, f2, pow2, false];
}

function DTri(){
	Derivative.call(this);
	this.vec = generateDElem(["\\sin", "\\cos", "\\tan"]);
}
inherit(DTri, Derivative);

function DExp(){
	Derivative.call(this);
	this.vec = generateDElem(["\\exp"]);
}
inherit(DExp, Derivative);

function DLog(){
	Derivative.call(this);
	this.vec = generateDElem(["\\log"]);
}
inherit(DLog, Derivative);

function generateIElem(funcList){
	var sign = (Math.floor(Math.random() * 2)) * 2 - 1;
	var f = Math.floor(Math.random() * 6) + 1;
	var fun = funcList[Math.floor(Math.random() * funcList.length)];
	var pow = 0;
	var f2 = Math.floor(Math.random() * 6) + 1;
	f *= f2;
	var pow2 = 1;
	// A special case that can be directly integrated
	if(fun === "\\exp" && Math.random() < 0.25){
		pow = ((Math.floor(Math.random() * 2)) * 2 - 1) * (Math.floor(Math.random() * 3) + 1);
		pow2 = pow + 1;
		f *= pow2;
	}
	return [sign, f, pow, fun, f2, pow2, false];
}

function ITri(){
	Integral.call(this);
	this.vec = generateIElem(["\\sin", "\\cos"]);
}
inherit(ITri, Integral);

function IExp(){
	Integral.call(this);
	this.vec = generateIElem(["\\exp"]);
}
inherit(IExp, Integral);

function symbolicDerivative(vec){
	var sign = vec[0], f = vec[1], pow = vec[2], fun = vec[3], f2 = vec[4], pow2 = vec[5];
	var polynomial = fun === "";
	switch(fun){
		case "\\sin":
			fun = "\\cos";
			pow += pow2-1;
			f *= f2 * pow2;
			break;
		case "\\cos":
			fun = "\\sin";
			pow += pow2-1;
			f *= f2 * pow2;
			sign *= -1;
			break;
		case "\\tan":
			fun = "\\cos^{-2}";
			pow += pow2-1;
			f *= f2 * pow2;
			break;
		case "\\exp":
			pow += pow2-1;
			f *= f2 * pow2;
			break;
		case "\\log":
			fun = "";
			pow = -1;
			f *= pow2;
			break;
	}
	if(polynomial)
		return [sign, f * pow, pow-1, fun, f2, pow2];
	else
		return [sign, f, pow, fun, f2, pow2];
}

function symbolicIntegral(vec){
	var sign = vec[0], f = vec[1], pow = vec[2], fun = vec[3], f2 = vec[4], pow2 = vec[5];
	var polynomial = fun === "";
	switch(fun){
		case "\\sin":
			fun = "\\cos";
			f /= f2;
			sign *= -1;
			break;
		case "\\cos":
			fun = "\\sin";
			f /= f2;
			break;
		case "\\exp":
			pow = 0;
			f /= f2 * pow2;
			break;
	}
	if(polynomial){
		if(pow === -1)
			return [sign, f, 0, "\\log", 1, 1, true];
		else
			return [sign, f / (pow+1), pow+1, fun, f2, pow2, true];
	}
	else
		return [sign, f, pow, fun, f2, pow2, true];
}

function start(){
	probClasses = [];
	if(document.getElementById("dpoly").checked)
		probClasses.push([1, DPoly]);
	if(document.getElementById("delem").checked){
		probClasses.push([0.3, DTri]);
		probClasses.push([0.3, DExp]);
		probClasses.push([0.3, DLog]);
	}
	if(document.getElementById("ipoly").checked)
		probClasses.push([1, IPoly]);
	if(document.getElementById("ielem").checked){
		probClasses.push([0.4, ITri]);
		probClasses.push([0.4, IExp]);
	}
	if(document.getElementById("comp").checked){
		probClasses.push([0.5, ComplexAdd]);
		probClasses.push([0.5, ComplexMultiply]);
	}
	if(document.getElementById("compdiv").checked){
		probClasses.push([0.5, ComplexDivision]);
	}
	if(probClasses.length === 0){
		alert("Please check at least one of problem classes");
		return;
	}

	var table = document.getElementById("scoreboard");
	while(table.firstChild)
		table.removeChild(table.firstChild);

	var headerRow = document.createElement("tr");
	for(var i = 0; i < probCount; i++){
		var header = document.createElement("td");
		header.innerHTML = i + 1;
		headerRow.appendChild(header);
	}
	table.appendChild(headerRow);

	var points = document.getElementById("points");
	points.style.display = "none";

	currentProblem = -1;
	results = [];
	next();
}

function next(){
	if(probCount <= currentProblem + 1){
		var incorrects = 0;
		for(var i = 0; i < results.length; i++){
			if(results[i])
				incorrects++;
		}
		var points = document.getElementById("points");
		points.innerHTML = "Congraturations!<br>"
			+ "You have answered " + (probCount - incorrects) + "/" + probCount + " problems correctly!";
		points.style.display = "initial";
		return;
	}
	var Problem = (function(){
		var cumulativeWeights = [];
		for(var i = 0; i < probClasses.length; i++){
			cumulativeWeights[i] = probClasses[i][0];
			if(0 < i)
				cumulativeWeights[i] += cumulativeWeights[i-1];
		}
		var picker = Math.random() * cumulativeWeights[probClasses.length-1];
		for(var i = 0; i < probClasses.length; i++){
			if(picker < cumulativeWeights[i])
				return probClasses[i][1];
		}
		// Should never reach here
	})();
	var vec = new Problem();

	var problem = document.getElementById("problem");
	problem.innerHTML = "$$" + vec.formatProblem() + "$$";

	var correctAnsStr = vec.solution();

	var options = [];
	for(var i = 0; i < optionCount; i++){
		var str;
		do{
			var ivec = new Problem();
			// Generate answers from the same class since they're more realistic
			str = ivec.solution();
			// Prevent random formulae from being "accidentally" the same as correct answer.
		}while(correctAnsStr === str);
		options[i] = str;
	}

	correctAns = Math.floor(Math.random() * optionCount);
	options[correctAns] = correctAnsStr;

	for(var i = 0; i < optionCount; i++){
		var elem = document.getElementById("ans" + (i + 1));
		elem.innerHTML = "$ \\displaystyle " + options[i] + "$";
		var radio = document.getElementById(i + 1);
		radio.checked = false;
	}

	var messageElem = document.getElementById("message");
	messageElem.innerHTML = "";

	var nextElem = document.getElementById("next");
	nextElem.style.display = "none";

	currentProblem++;
	var scoreboard = document.getElementById("scoreboard");
	if(0 < currentProblem)
		scoreboard.firstChild.children[currentProblem-1].style.border = "";
	scoreboard.firstChild.children[currentProblem].style.border = "3px solid #0000ff";

	MathJax.Hub.Typeset();
}

function answer(){
	var radio = document.getElementById(correctAns + 1);
	var message;
	if(radio.checked)
		message = "Correct";
	else
		message = "Incorrect";
	var messageElem = document.getElementById("message");
	messageElem.innerHTML = message;

	var nextElem = document.getElementById("next");
	nextElem.value = currentProblem < probCount-1 ? "Next Problem" : "Finish";
	nextElem.style.display = radio.checked ? "inline" : "none";

	results[currentProblem] |= !radio.checked;
	var scoreboard = document.getElementById("scoreboard");
	scoreboard.firstChild.children[currentProblem].style.backgroundColor = !results[currentProblem] ? "#00ff00" : "#ff0000";
}

window.onload = start;

		</script>

	</body>
</html>
